---
kind: pipeline
name: default

clone:
    disable: true

steps:

- name: clone-and-verify
  image: quay.io/natlibfi/drone-verify-git
  settings:
     signing_keys:
       from_secret: signing_keys

- name: audit
  image: node:12
  commands: ['npm audit --package-json-only --audit-level=moderate']
            
- name: install
  image: node:12
  commands: ['npm ci --ignore-scripts']

- name: test
  image: node:12
  commands: ['npm test']

- name: static-security-scan
  image: quay.io/natlibfi/nodejsscan
  commands: ['python /usr/src/app/cli.py -d src']

- name: npm-publish
  image: plugins/npm
  settings:
    registry: 'https://registry.npmjs.org/'
    token:
      from_secret: npm_token
  when:
    event: tag   
---
kind: secret
name: npm_token
data: 69bfemLk1u/5G2yEvDOtvJh6ic3G+JdRdME8WXtrkwaAWhiMjFRg9XR3qUg9PSJJMn+35NfFejj/818vDI7xhw==
---
kind: secret
name: signing_keys
data: qmdxQP8a0KNbsGZotoGZh4Cu16U6d0fZfon2V62yZ38q3yrH6eaYyyfIRqCk/TYJi5XJ61aPFz2s/5ndXb0bdFvmuXn50rIh6fH88HQLd9cOmVkbKjKV3Xucl+N2+Wbszly28HeFlzLTJCN6Kq2Zdh3t7yQCFqEn1ozS5e35WPEMhnKCu9E3erY3R9IlEQjYJ4GX0Na5cfIABVWI4+VQcWOTmEXyUgnCP4NX7GcRQS6bRFtmuvum5ja6trkRVZQVI7n675uI5eyyexdj7cSsEkYWR0/Wg+4K/4odvwLYjJi2c+CYa07USvGVZq3l2QBJ/luL3sayTowh6GCQt0IHEXhem4XDF/kb6ZGb4ME1HopMYfMSJaH/zm+/7C1b7k/5ErVh+/Y7EYqJE2dmhLxYi7xzXtGg3z+DkPPeX+TadrV+n78Z/+We1PurHZzir1K8p7TbWPEKAagM3MPATNZvcBZ9r+joUMPx5WdFtxLhgtVWTZR9ARll9vBw9Boxflx9kGoWdE1tuguMTgqzCA8Jg3GYCw04L4HBQfHXV7KF3Mb3mgDj/E99UT6lcDuKxHdlm8aSjPOCkBHPUxYGl0MeNtIf0JQxXHbmb0bCeskg0NEQJvvZEgwJE86ASQ6llYWBTb2rVCmmNXcW/ZDjkYwY/DYTgiJ7R4pyNVqud8l/xN3CfKc2tivCTgTuJkylyLxfkEyLVRWU6xhVsNxlPIj2Qxo63KNY5qKHqibhMLVxPzj6yuJ5YxzuJ+OnypQxpsfyofEhe8TyK18z+0achR/yyJt+gMgKgxvhhUl6Zwn+9Ttju3f1f94gONwu5WqxGFd648uv7VmTz4QkxqZa8Y9UNVRD4hmjsriU9mbEWa2VtTAKtifBFjP3tqKh8ck2OjwnAeXXgULKJQWz8r2b0/rlKxFeq+lMfS84Zp483YwyFUPntGt6ZjDKgUow2YoFhFcJEyHuy8OwDgdWCA1I9CFNiPoiYzDk6Xq9CiHN1pMAXoz111o9a3AKqUy+pp8EFwnCtSyVHxMx0i5OYswkb/fYJkmGd1JA9l5OFVA0nJd/AU8kwdVwN+5/NIdTT5SjcEcE4OfgnilDy7hrBshYsRCweX/tYjD4TFaGzHSxG8CFnC064UOYisU6JP29sroBguXdRB8uuJh1Sa7oOfHMbpWzZFN0Jeqali0EJyN7Zv+YccefuOyNHA3OvI8n95skCXVvbaP+9wJjqa+EObr2JdxfQUGbdEqQUrrPe1QQ5phjZUGEhONVZfbn6vibcK59tlBuRjqrm0ioLyt23WZnoxCIn9zRTL8s7YW3k2EE4NyKqG7f195m6CmiGRKwIYe9xP6mYwzXi4WnOOtqM/f8z66t3engb+jnjtMwzDuedBQpLnn8pGBljUum35OBT4pKh2jBpXHIkq7LQupcFRJYHN20C0u6mCYqDnqRDVubJwN+Imn3FWTambaKdwGDqX13CxT4oGi0Q/PfUB5G8I0mv0u7/GrySZawarEfJ4a3GyKCAFEdHD+WGaTuQKi1u5503dMSsf3FLZpvyfDoeZSmx7EeCLSvV6f0abGhEx36OppR3ix1Ru74+iyO1PoXN9HlnOfYxbKPQUHmxpaiopWXQQ9iagSqbzLlBeRqjZqUlwJ5yvgIr7gADLYX4gyLFwtvTFvV2ZbEdMcP8VW8qShWrlGmO/4V7egoXNlniiPULzaQWwiglXeFSBXBFwknpRCvMlUJ8vmnC9AoBWDX3pZlFXKgdPGMW+1Vv1TQC+3TlcdRwPAUC4eWtzEYFLgzC+L5Kb+XOZrP4hFsJFGXbrbfLTWa+gwYt16qj25KOpzvXT3uMXT9ocFK+A3bX+AiomL6fmI8TDW0sGnWRwD5dWvzMhH7Zrg5wazdSHTeYLZkQi3IDxlObbtwwIU9h7zOTfYZlXDJuEisnpxOIvWaeAezzY9Bk1l9XNuv96q+S7WYUXfiFMI+MLjv40ipKEGO1PPAXWniHkZNVH2u6uf/16H6EufEyQZAf5+6FnkBri/Wvq47MMpK4XDehU0OL/fIqvBRMGcgTiwwI4aX7UecCgjzTgY3ZXj48Q7sWZJ5PdjF4Qo4pfUt+pZ7hXVdzrqvX9OyZe2gXpXSkJu5QNDPma2N2mRn5lSXZoOcIk/PULYQ3seXgzK+P7oGqB+N+qZuDV+IsGWmGRFRK+yriB7LB7PGDT5/co0DHVlxaphOjjSLliZpbP96321faCIyjTQN8LI4Qc8VkgQ3wkNInM6GMNoDlZmt+zkNlSnVPF5NvnkyXnH3qfiSPdLyxWt61FZAebmVa0IOvCmSKvzr0ZDqRy8Z0yf4gtf1zQ9RBofWjFGNJJasPzysWQq4mevM6OA9hYyet7HJQ72agOT6vy1NzvsamWvQfRM+GNcUY518Dv+yF+LbkCsYg63vtaoQsY/tz1/tgFCdSY32EfSi+GKrWLnRQo9gkFeHhmJlDEEa0BhWT/Zeg639LVKu7C/kmcZajCIyEEhBvsceQrAH4+wFIu2KqhqXNsPtI4srolWaH3Lk+68xrnf9pChg4fjlsPO+ODtURftUwUG0hwPXm7TK6V6RRiioYhk4W4yuvyRqRomVyv/JwL+hBkec37at6mvPEuL368X6n6bwGPAmaqwDHwOWKvNL5o+iu8gS+qDmglJqO6za/H0zR6cMTvWYQrjJa1jaENaPDk3UWM37y1Qa9tWNH7UL04FSpKJV/ZpfgHo9qEbdx+SVPHFR4D3qhVCDQ7LQZcQhHrV18DLt92paF9WXAiwNqvgtDDZlRejMcTcfwIdh9hFnhybv4YL9Mb7ossB+xOBC6HxwPdteyRUVWwG4pIZsYqZ441veAlYCL9GG5T4kqEfNBnI/62ZUMv9JGh9cZB1dDsSE3GhChFwU6pPajY2x2i/ZiOQDTq5O51RGBXF+kCv/kmMZCc+BJ/8/pWvs1BstzoIdf8EaBK8ec0+4WW7NxhV97jdHniSGCXZHLAwQ/jqK3w1Ya7lcl6KC+6iImN3ZXUjOsi0xb3s7AzOzvWQr543ro/NPrmBCumzPFFPZ1NhSUCMt6U+W+LHFfcvNnd5f7+NAd8y6z/O6M658Pk2h68cbP8yXfKq451qzQKE6qa2d0vKNVtEnnnyRk8+4fup93KSYCKJCa3S6RkSNbllDVFBqdK/jU8c4ao8YXcMdoQ==
---
kind: signature
hmac: d1c1c5735f5539e094824818512cc1b4d1639fcf59c2fce7ebd0484ebaf1f8d1

...
