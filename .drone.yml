---
kind: pipeline
name: default

steps:

- name: audit
  image: node:12
  commands: ['npm audit --package-json-only --audit-level=moderate']
            
- name: install
  image: node:12
  commands: ['npm ci --ignore-scripts']

- name: test
  image: node:12
  commands: ['npm test']

- name: static-security-scan
  image: quay.io/natlibfi/nodejsscan
  commands: ['python /usr/src/app/cli.py -d src']

- name: npm-publish
  image: plugins/npm
  settings:
    registry: 'https://registry.npmjs.org/'
    token:
      from_secret: npm_token
  when:
    event: tag   
---
kind: secret
name: npm_token
data: 69bfemLk1u/5G2yEvDOtvJh6ic3G+JdRdME8WXtrkwaAWhiMjFRg9XR3qUg9PSJJMn+35NfFejj/818vDI7xhw==
---
kind: signature
hmac: 3bc89740d33005628e9769db9fd8e0a593fa3713ec0da9119f85bf1e2b4b583c

...
