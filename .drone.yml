---
kind: pipeline
name: default

clone:
    disable: true

steps:

- name: clone-and-verify
  image: quay.io/natlibfi/drone-verify-git
  settings:
     signing_keys:
       from_secret: signing_keys

- name: audit
  image: node:12
  commands: ['npm audit --package-json-only --audit-level=moderate']
            
- name: install
  image: node:12
  commands: ['npm ci --ignore-scripts']

- name: test
  image: node:12
  commands: ['npm test']

- name: static-security-scan
  image: quay.io/natlibfi/nodejsscan
  commands: ['python /usr/src/app/cli.py -d src']

- name: npm-publish
  image: plugins/npm
  settings:
    registry: 'https://registry.npmjs.org/'
    token:
      from_secret: npm_token
  when:
    event: tag   
---
kind: secret
name: npm_token
data: 69bfemLk1u/5G2yEvDOtvJh6ic3G+JdRdME8WXtrkwaAWhiMjFRg9XR3qUg9PSJJMn+35NfFejj/818vDI7xhw==
---
kind: secret
name: signing_keys
---
kind: signature
hmac: 67e8fbc69c962413dc6a7fffd35c391c23a2db14a8c4de575f32a38d6b011737

...
