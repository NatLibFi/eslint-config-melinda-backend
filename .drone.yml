---
kind: pipeline
name: default

clone:
    disable: true

steps:

- name: clone-and-verify
  image: quay.io/natlibfi/drone-verify-git
  settings:
     signing_keys:
       from_secret: signing_keys

- name: audit
  image: node:12
  commands: ['npm audit --package-json-only --audit-level=moderate']
            
- name: install
  image: node:12
  commands: ['npm ci --ignore-scripts']

- name: test
  image: node:12
  commands: ['npm test']

- name: static-security-scan
  image: quay.io/natlibfi/nodejsscan
  commands: ['python /usr/src/app/cli.py -d src']

- name: npm-publish
  image: plugins/npm
  settings:
    registry: 'https://registry.npmjs.org/'
    token:
      from_secret: npm_token
  when:
    event: tag   
---
kind: secret
name: npm_token
data: 69bfemLk1u/5G2yEvDOtvJh6ic3G+JdRdME8WXtrkwaAWhiMjFRg9XR3qUg9PSJJMn+35NfFejj/818vDI7xhw==
---
kind: secret
name: signing_keys
data: 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
---
kind: signature
hmac: 67e8fbc69c962413dc6a7fffd35c391c23a2db14a8c4de575f32a38d6b011737
...
